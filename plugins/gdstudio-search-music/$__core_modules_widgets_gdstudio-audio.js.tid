created: 20250530105155960
modified: 20250530130618574
module-type: widget
tags: gdstudio éŸ³ä¹æ’­æ”¾å™¨
title: $:/core/modules/widgets/gdstudio-audio.js
type: application/javascript

/*\
title: $:/core/modules/widgets/gdstudio-audio.js
type: application/javascript
module-type: widget

GDStudio Audio Widget - è¿·ä½ éŸ³é¢‘æ’­æ”¾å™¨
\*/

"use strict";

var Widget = require("$:/core/modules/widgets/widget.js").widget;

var GDStudioAudioWidget = function(parseTreeNode,options) {
    this.initialise(parseTreeNode,options);
};

GDStudioAudioWidget.prototype = new Widget();

GDStudioAudioWidget.prototype.execute = function() {
    this.coverUrl = this.getAttribute("cover-url", "");
    this.musicUrl = this.getAttribute("music-url", "");
    this.songName = this.getAttribute("song-name", "æœªçŸ¥æ­Œæ›²");
    this.artist = this.getAttribute("artist", "æœªçŸ¥æ­Œæ‰‹");
    
    this.makeChildWidgets();
};

GDStudioAudioWidget.prototype.createDefaultCover = function() {
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
        '<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">' +
        '<rect width="100%" height="100%" fill="#f0f0f0"/>' +
        '</svg>'
    );
};

GDStudioAudioWidget.prototype.render = function(parent,nextSibling) {
    var self = this;
    this.parentDomNode = parent;
    this.computeAttributes();
    this.execute();
    
    var playerDiv = this.document.createElement("div");
    playerDiv.className = "gdstudio-mini-player";
    
    var coverContainer = this.document.createElement("div");
    coverContainer.className = "gdstudio-mini-cover";
    
    var coverImg = this.document.createElement("img");
    coverImg.src = this.coverUrl || this.createDefaultCover();
    coverImg.className = "gdstudio-mini-cover-img";
    
    var playButton = this.document.createElement("button");
    playButton.className = "gdstudio-mini-play-btn";
    playButton.innerHTML = "â–¶";
    
    coverContainer.appendChild(coverImg);
    coverContainer.appendChild(playButton);
    
    var infoSection = this.document.createElement("div");
    infoSection.className = "gdstudio-mini-info";
    
    var musicName = this.document.createElement("div");
    musicName.className = "gdstudio-music-name";
    musicName.textContent = this.songName + " - " + this.artist;
    
    var controls = this.document.createElement("div");
    controls.className = "gdstudio-mini-controls";
    
    var timeDisplay = this.document.createElement("span");
    timeDisplay.className = "gdstudio-time";
    timeDisplay.textContent = "0:00/0:00";
    
    var progressBar = this.document.createElement("div");
    progressBar.className = "gdstudio-progress";
    
    var progressFill = this.document.createElement("div");
    progressFill.className = "gdstudio-progress-fill";
    progressBar.appendChild(progressFill);

// åœ¨ controls åŒºåŸŸæ·»åŠ ä¸‹è½½æŒ‰é’®  
// ä¸‹è½½çš„ SVG ä»£ç ï¼Œä»æ¡ç›®textè·å–  
const downloadSvg = this.wiki.getTiddlerText("$:/core/images/downloadSvg");  
var downloadBtn = this.document.createElement("button");  
downloadBtn.className = "tc-btn-invisible gdstudio-download-btn";  
downloadBtn.innerHTML = downloadSvg;  
downloadBtn.title = "ä¸‹è½½éŸ³é¢‘";

// ä¸‹è½½æŒ‰é’®äº‹ä»¶å¤„ç†  
downloadBtn.addEventListener("click", function() {  
    if (!self.musicUrl) return;  
      
    // æ˜¾ç¤ºä¸‹è½½çŠ¶æ€  
    downloadBtn.innerHTML = "â³";  
    downloadBtn.disabled = true;  
      
    // ä½¿ç”¨ fetch è·å–éŸ³é¢‘æ•°æ®  
    fetch(self.musicUrl)  
        .then(function(response) {  
            if (!response.ok) {  
                throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');  
            }  
            return response.blob();  
        })  
        .then(function(blob) {  
            // åˆ›å»ºä¸‹è½½é“¾æ¥  
            var link = self.document.createElement("a");  
            var url = URL.createObjectURL(blob);  
            link.setAttribute("href", url);  
              
            // è®¾ç½®ä¸‹è½½æ–‡ä»¶å - ä¿®æ”¹è¿™é‡Œ  
            var filename = (self.songName || "æœªçŸ¥æ­Œæ›²") + "-" + (self.artist || "æœªçŸ¥æ­Œæ‰‹") + ".mp3";  
            link.setAttribute("download", filename);  
              
            // è§¦å‘ä¸‹è½½  
            self.document.body.appendChild(link);  
            link.click();  
            self.document.body.removeChild(link);  
              
            // æ¸…ç† URL å¯¹è±¡  
            URL.revokeObjectURL(url);  
              
            // æ¢å¤æŒ‰é’®çŠ¶æ€  
            downloadBtn.innerHTML = "â¬‡";  
            downloadBtn.disabled = false;  
        })  
        .catch(function(error) {  
            console.error('ä¸‹è½½å¤±è´¥:', error);  
            alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–éŸ³é¢‘é“¾æ¥');  
              
            // æ¢å¤æŒ‰é’®çŠ¶æ€  
            downloadBtn.innerHTML = "â¬‡";  
            downloadBtn.disabled = false;  
        });  
});
// æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œå…è®¸ç”¨æˆ·æ‰‹åŠ¨è°ƒèŠ‚æ’­æ”¾ä½ç½®
progressBar.addEventListener("click", function(e) {  
    if (audio.duration) {  
        var rect = progressBar.getBoundingClientRect();  
        var clickX = e.clientX - rect.left;  
        var percentage = clickX / rect.width;  
        var newTime = percentage * audio.duration;  
        audio.currentTime = newTime;  
    }  
});
    
    // åˆå¹¶çš„éŸ³é‡æ§åˆ¶æŒ‰é’®
// éŸ³é‡çš„ SVG ä»£ç ï¼Œä»æ¡ç›®textè·å–
const volumeSvg = this.wiki.getTiddlerText("$:/core/images/volume");
    var volumeBtn = this.document.createElement("button");
    volumeBtn.className = "gdstudio-volume-btn";
    volumeBtn.innerHTML = volumeSvg;
    
    // éŸ³é‡é¢æ¿
    var volumePanel = this.document.createElement("div");
    volumePanel.className = "gdstudio-volume-panel";
    
    var volumeSlider = this.document.createElement("input");
    volumeSlider.type = "range";
    volumeSlider.min = "0";
    volumeSlider.max = "100";
    volumeSlider.value = "50";
    volumeSlider.className = "gdstudio-volume-slider";
    volumePanel.appendChild(volumeSlider);
    
    controls.appendChild(timeDisplay);
    controls.appendChild(progressBar);
    controls.appendChild(volumeBtn);
controls.appendChild(downloadBtn); // æ–°å¢ä¸‹è½½æŒ‰é’®  
    controls.appendChild(volumePanel);
    
    infoSection.appendChild(musicName);
    infoSection.appendChild(controls);
    
    var audio = this.document.createElement("audio");
    if(this.musicUrl) {
        audio.src = this.musicUrl;
    }
    audio.preload = "metadata";
    audio.volume = 0.5; // è®¾ç½®åˆå§‹éŸ³é‡
    
    playerDiv.appendChild(coverContainer);
    playerDiv.appendChild(infoSection);
    playerDiv.appendChild(audio);
    
    // äº‹ä»¶å¤„ç†
    var isPlaying = false;
    var volumeVisible = false;
    var isMuted = false;
    var previousVolume = 0.5;
    
    // æ’­æ”¾æ§åˆ¶
// æš‚åœæ’­æ”¾çš„ SVG ä»£ç ï¼Œä»æ¡ç›®textè·å–
const pauseSvg = this.wiki.getTiddlerText("$:/core/images/gdstudio-pause-music");
    playButton.addEventListener("click", function() {
        if (!audio.src) return;
        if (isPlaying) {
            audio.pause();
            playButton.innerHTML = "â–¶";
            coverImg.classList.remove("spinning");
        } else {
            audio.play();
            playButton.innerHTML = pauseSvg;
            coverImg.classList.add("spinning");
        }
        isPlaying = !isPlaying;
    });
    
    // åˆå¹¶çš„éŸ³é‡æŒ‰é’®æ§åˆ¶
    volumeBtn.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (!volumeVisible) {
            // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šæ˜¾ç¤ºéŸ³é‡æ»‘å—
            volumeVisible = true;
            volumePanel.classList.add("visible");
        } else {
            // éŸ³é‡æ»‘å—å·²æ˜¾ç¤ºæ—¶ï¼šåˆ‡æ¢é™éŸ³çŠ¶æ€
            if (isMuted) {
                // å–æ¶ˆé™éŸ³
                audio.volume = previousVolume;
                volumeSlider.value = previousVolume * 100;
                volumeBtn.innerHTML = volumeSvg;
                isMuted = false;
            } else {
                // é™éŸ³
                previousVolume = audio.volume;
                audio.volume = 0;
                volumeSlider.value = 0;
                volumeBtn.innerHTML = "ğŸ”‡";
                isMuted = true;
            }
        }
    });
    
    // éŸ³é‡æ»‘å—æ§åˆ¶
    volumeSlider.addEventListener("input", function() {
        var volume = this.value / 100;
        audio.volume = volume;
        
        if (volume === 0) {
            volumeBtn.innerHTML = "ğŸ”‡";
            isMuted = true;
        } else {
            volumeBtn.innerHTML = volumeSvg;
            isMuted = false;
            if (volume > 0) {
                previousVolume = volume;
            }
        }
    });
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­éŸ³é‡é¢æ¿
    this.document.addEventListener("click", function(e) {
        if (!volumeBtn.contains(e.target) && !volumePanel.contains(e.target)) {
            volumeVisible = false;
            volumePanel.classList.remove("visible");
        }
    });
    
    // æ—¶é—´æ›´æ–°
    audio.addEventListener("timeupdate", function() {
        if (audio.duration) {
            var progress = (audio.currentTime / audio.duration) * 100;
            progressFill.style.width = progress + "%";
            
            var currentMin = Math.floor(audio.currentTime / 60);
            var currentSec = Math.floor(audio.currentTime % 60);
            var totalMin = Math.floor(audio.duration / 60);
            var totalSec = Math.floor(audio.duration % 60);
            
            timeDisplay.textContent = currentMin + ":" + (currentSec < 10 ? "0" : "") + currentSec + 
                                    "/" + totalMin + ":" + (totalSec < 10 ? "0" : "") + totalSec;
        }
    });
    
    audio.addEventListener("ended", function() {
        playButton.innerHTML = "â–¶";
        coverImg.classList.remove("spinning");
        isPlaying = false;
    });
    
    parent.insertBefore(playerDiv, nextSibling);
    this.domNodes.push(playerDiv);
};

GDStudioAudioWidget.prototype.refresh = function(changedTiddlers) {
    var changedAttributes = this.computeAttributes();
    if (Object.keys(changedAttributes).length > 0) {
        this.refreshSelf();
        return true;
    }
    return this.refreshChildren(changedTiddlers);
};

exports["gdstudio-audio"] = GDStudioAudioWidget;
