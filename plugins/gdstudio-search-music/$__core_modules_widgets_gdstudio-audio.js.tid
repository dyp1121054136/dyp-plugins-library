created: 20250530105155960
modified: 20250530130618574
module-type: widget
tags: gdstudio éŸ³ä¹æ’­æ”¾å™¨
title: $:/core/modules/widgets/gdstudio-audio.js
type: application/javascript

/*\
title: $:/core/modules/widgets/gdstudio-audio.js
type: application/javascript
module-type: widget

GDStudio Audio Widget - è¿·ä½ éŸ³é¢‘æ’­æ”¾å™¨
\*/

"use strict";

var Widget = require("$:/core/modules/widgets/widget.js").widget;

var GDStudioAudioWidget = function(parseTreeNode,options) {
    this.initialise(parseTreeNode,options);
};

GDStudioAudioWidget.prototype = new Widget();

GDStudioAudioWidget.prototype.execute = function() {
    // åŸºæœ¬å±æ€§
    this.coverUrl = this.getAttribute("cover-url", "");
    this.musicUrl = this.getAttribute("music-url", "");
    this.songName = this.getAttribute("song-name", "æœªçŸ¥æ­Œæ›²");
    this.artist = this.getAttribute("artist", "æœªçŸ¥æ­Œæ‰‹");
    this.playerWidth = this.getAttribute("width", "280px");
    this.progressHeight = this.getAttribute("progress-height", "6px");
    
    // å›¾æ ‡å¤§å°æ§åˆ¶
    this.iconSize = this.getAttribute("icon-size", "24px");
    this.playIconSize = this.getAttribute("play-icon-size", this.iconSize);
    this.pauseIconSize = this.getAttribute("pause-icon-size", this.iconSize);
    this.muteIconSize = this.getAttribute("mute-icon-size", this.iconSize);
    this.unmuteIconSize = this.getAttribute("unmute-icon-size", this.iconSize);
    this.volumeIconSize = this.getAttribute("volume-icon-size", this.iconSize);
    
    // å›¾æ ‡æ¡ç›®å¼•ç”¨
    this.playIconTiddler = this.getAttribute("play-icon", "");
    this.pauseIconTiddler = this.getAttribute("pause-icon", "");
    this.muteIconTiddler = this.getAttribute("mute-icon", "");
    this.unmuteIconTiddler = this.getAttribute("unmute-icon", "");
    this.volumeIconTiddler = this.getAttribute("volume-icon", "");
    
    // é»˜è®¤æ–‡æœ¬å›¾æ ‡
    this.defaultPlayIcon = "â–¶";
    this.defaultPauseIcon = "â¸";
    this.defaultMuteIcon = "ğŸ”‡";
    this.defaultUnmuteIcon = "ğŸ”Š";
    this.defaultVolumeIcon = "ğŸµ";
    
    this.makeChildWidgets();
};

// è§£æå›¾æ ‡å¼•ç”¨ï¼Œæ”¯æŒ {{tiddler|size}} è¯­æ³•
GDStudioAudioWidget.prototype.parseIconReference = function(iconRef) {
    if (!iconRef) return { tiddler: "", size: "" };
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ {{tiddler|size}} æ ¼å¼
    var match = iconRef.match(/^\{\{([^|]+)(?:\|([^}]+))?\}\}$/);
    if (match) {
        return {
            tiddler: match[1],
            size: match[2] || ""
        };
    }
    
    // æ™®é€šçš„ tiddler å¼•ç”¨
    return {
        tiddler: iconRef,
        size: ""
    };
};

GDStudioAudioWidget.prototype.getIconContent = function(iconRef, defaultIcon, defaultSize) {
    var parsed = this.parseIconReference(iconRef);
    var tiddlerTitle = parsed.tiddler;
    var iconSize = parsed.size || defaultSize;
    
    if (!tiddlerTitle) {
        return defaultIcon;
    }
    
    var tiddler = this.wiki.getTiddler(tiddlerTitle);
    if (!tiddler || !tiddler.fields.text) {
        return defaultIcon;
    }
    
    var text = tiddler.fields.text;
    
    // å¦‚æœåŒ…å«å‚æ•°å®šä¹‰æˆ–å˜é‡å¼•ç”¨ï¼Œéœ€è¦è¿›è¡Œ wikify å¤„ç†
    if (text.indexOf('\\parameters') !== -1 || text.indexOf('<<') !== -1) {
        try {
            // è§£ææ–‡æœ¬ä¸º parse tree
            var parseTreeNode = this.wiki.parseText("text/vnd.tiddlywiki", text, {
                parseAsInline: false
            });
            
            // åˆ›å»ºæ¸²æŸ“ widget
            var renderWidget = this.wiki.makeWidget(parseTreeNode, {
                parentWidget: this,
                document: this.document
            });
            
            // è®¾ç½®å¤§å°å‚æ•°
            renderWidget.setVariable("size", iconSize);
            
            // æ¸²æŸ“åˆ°ä¸´æ—¶å®¹å™¨
            var container = this.document.createElement("div");
            renderWidget.render(container, null);
            
            // è¿”å›æ¸²æŸ“åçš„ HTML
            return container.innerHTML;
        } catch (e) {
            console.error("Error rendering icon:", tiddlerTitle, e);
            return defaultIcon;
        }
    }
    
    // å¯¹äºç®€å•çš„ SVGï¼Œç›´æ¥è¿”å›å¹¶è®¾ç½®å¤§å°
    if (text.indexOf('<svg') !== -1 && iconSize) {
        // å°è¯•åœ¨ SVG ä¸­è®¾ç½® width å’Œ height
        var svgWithSize = text.replace(/<svg([^>]*)>/i, function(match, attrs) {
            // ç§»é™¤ç°æœ‰çš„ width å’Œ height å±æ€§
            attrs = attrs.replace(/\s*(width|height)\s*=\s*["'][^"']*["']/gi, '');
            return '<svg' + attrs + ' width="' + iconSize + '" height="' + iconSize + '">';
        });
        return svgWithSize;
    }
    
    return text;
};

// åˆ›å»ºç»Ÿä¸€çš„ç©ºç™½æµ·æŠ¥èƒŒæ™¯
GDStudioAudioWidget.prototype.createDefaultCover = function() {
    // åˆ›å»ºä¸€ä¸ªç®€å•çš„ç°è‰²èƒŒæ™¯ï¼Œè€Œä¸æ˜¯æ˜¾ç¤ºé”™è¯¯å›¾ç‰‡
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
    );
};

GDStudioAudioWidget.prototype.render = function(parent,nextSibling) {
    var self = this;
    this.parentDomNode = parent;
    this.computeAttributes();
    this.execute();
    
    // åˆ›å»ºä¸»å®¹å™¨
    var playerDiv = this.document.createElement("div");
    playerDiv.className = "gdstudio-mini-player";
    if(this.playerWidth !== "280px") playerDiv.style.width = this.playerWidth;
    
    // æµ·æŠ¥å®¹å™¨
    var coverContainer = this.document.createElement("div");
    coverContainer.className = "gdstudio-mini-cover";
    
    var coverImg = this.document.createElement("img");
    // ä½¿ç”¨ç»Ÿä¸€çš„é»˜è®¤èƒŒæ™¯è€Œä¸æ˜¯é”™è¯¯å›¾ç‰‡
    coverImg.src = this.coverUrl || this.createDefaultCover();
    coverImg.className = "gdstudio-mini-cover-img";
    
    // æ·»åŠ é”™è¯¯å¤„ç†ï¼Œç¡®ä¿æ˜¾ç¤ºç»Ÿä¸€èƒŒæ™¯
    coverImg.addEventListener("error", function() {
        coverImg.src = self.createDefaultCover();
    });
    
    var playButton = this.document.createElement("button");
    playButton.className = "gdstudio-mini-play-btn";
    playButton.innerHTML = this.getIconContent(this.playIconTiddler, this.defaultPlayIcon, this.playIconSize);
    
    coverContainer.appendChild(coverImg);
    coverContainer.appendChild(playButton);
    
    // ä¿¡æ¯åŒº
    var infoSection = this.document.createElement("div");
    infoSection.className = "gdstudio-mini-info";
    
    var musicName = this.document.createElement("div");
    musicName.className = "gdstudio-music-name";
    musicName.textContent = this.songName + " - " + this.artist;
    
    // æ§åˆ¶åŒº
    var controls = this.document.createElement("div");
    controls.className = "gdstudio-mini-controls";
    
    var progressSection = this.document.createElement("div");
    progressSection.className = "gdstudio-progress-section";
    
    var timeDisplay = this.document.createElement("span");
    timeDisplay.className = "gdstudio-time";
    timeDisplay.textContent = "0:00/0:00";
    
    var progressBar = this.document.createElement("div");
    progressBar.className = "gdstudio-progress";
    if(this.progressHeight !== "6px") progressBar.style.height = this.progressHeight;
    
    var progressFill = this.document.createElement("div");
    progressFill.className = "gdstudio-progress-fill";
    progressBar.appendChild(progressFill);
    
    progressSection.appendChild(timeDisplay);
    progressSection.appendChild(progressBar);
    
    // åˆ†ç¦»çš„é™éŸ³æŒ‰é’®
    var muteBtn = this.document.createElement("button");
    muteBtn.className = "gdstudio-mute-btn";
    muteBtn.innerHTML = this.getIconContent(this.unmuteIconTiddler, this.defaultUnmuteIcon, this.unmuteIconSize);
    
    // åˆ†ç¦»çš„éŸ³é‡æŒ‰é’®
    var volumeBtn = this.document.createElement("button");
    volumeBtn.className = "gdstudio-volume-btn";
    volumeBtn.innerHTML = this.getIconContent(this.volumeIconTiddler, this.defaultVolumeIcon, this.volumeIconSize);
    
    var volumePanel = this.document.createElement("div");
    volumePanel.className = "gdstudio-volume-panel";
    
    var volumeSlider = this.document.createElement("input");
    volumeSlider.type = "range";
    volumeSlider.min = "0";
    volumeSlider.max = "100";
    volumeSlider.value = "50";
    volumeSlider.className = "gdstudio-volume-slider";
    volumePanel.appendChild(volumeSlider);
    
    controls.appendChild(progressSection);
    controls.appendChild(muteBtn);
    controls.appendChild(volumeBtn);
    controls.appendChild(volumePanel);
    
    infoSection.appendChild(musicName);
    infoSection.appendChild(controls);
    
    // éŸ³é¢‘å…ƒç´ 
    var audio = this.document.createElement("audio");
    if(this.musicUrl) audio.src = this.musicUrl;
    audio.preload = "metadata";
    
    playerDiv.appendChild(coverContainer);
    playerDiv.appendChild(infoSection);
    playerDiv.appendChild(audio);
    
    this.addEventListeners(playButton, audio, coverImg, progressFill, timeDisplay, volumeSlider, muteBtn, volumeBtn, volumePanel, progressBar);
    
    parent.insertBefore(playerDiv, nextSibling);
    this.domNodes.push(playerDiv);
};

GDStudioAudioWidget.prototype.addEventListeners = function(playButton, audio, coverImg, progressFill, timeDisplay, volumeSlider, muteBtn, volumeBtn, volumePanel, progressBar) {
    var self = this;
    var isPlaying = false;
    var volumeVisible = false;
    var isDragging = false;
    var isMuted = false;
    var previousVolume = 0.5;
    
    // æ’­æ”¾æ§åˆ¶
    playButton.addEventListener("click", function(e) {
        e.preventDefault();
        if (!audio.src) return;
        
        if (isPlaying) {
            audio.pause();
            playButton.innerHTML = self.getIconContent(self.playIconTiddler, self.defaultPlayIcon, self.playIconSize);
            coverImg.classList.remove("spinning");
        } else {
            audio.play().catch(function(error) {
                console.error("Audio play failed:", error);
            });
            playButton.innerHTML = self.getIconContent(self.pauseIconTiddler, self.defaultPauseIcon, self.pauseIconSize);
            coverImg.classList.add("spinning");
        }
        isPlaying = !isPlaying;
    });
    
    // æ—¶é—´æ›´æ–°
    audio.addEventListener("timeupdate", function() {
        if (audio.duration && !isNaN(audio.duration)) {
            var progress = (audio.currentTime / audio.duration) * 100;
            progressFill.style.width = progress + "%";
            
            var currentMin = Math.floor(audio.currentTime / 60);
            var currentSec = Math.floor(audio.currentTime % 60);
            var totalMin = Math.floor(audio.duration / 60);
            var totalSec = Math.floor(audio.duration % 60);
            
            timeDisplay.textContent = currentMin + ":" + (currentSec < 10 ? "0" : "") + currentSec + 
                                    "/" + totalMin + ":" + (totalSec < 10 ? "0" : "") + totalSec;
        }
    });
    
    audio.addEventListener("loadedmetadata", function() {
        if (audio.duration && !isNaN(audio.duration)) {
            var totalMin = Math.floor(audio.duration / 60);
            var totalSec = Math.floor(audio.duration % 60);
            timeDisplay.textContent = "0:00/" + totalMin + ":" + (totalSec < 10 ? "0" : "") + totalSec;
        }
    });
    
    // è¿›åº¦æ¡æ‹–åŠ¨
    progressBar.addEventListener("click", function(e) {
        if (audio.duration) {
            var rect = progressBar.getBoundingClientRect();
            var clickX = e.clientX - rect.left;
            audio.currentTime = (clickX / rect.width) * audio.duration;
        }
    });
    
    progressBar.addEventListener("mousedown", function(e) {
        isDragging = true;
        e.preventDefault();
    });
    
    self.document.addEventListener("mousemove", function(e) {
        if (isDragging && audio.duration) {
            var rect = progressBar.getBoundingClientRect();
            var clickX = e.clientX - rect.left;
            audio.currentTime = Math.max(0, Math.min((clickX / rect.width) * audio.duration, audio.duration));
        }
    });
    
    self.document.addEventListener("mouseup", function() {
        isDragging = false;
    });
    
    // åˆ†ç¦»çš„é™éŸ³æ§åˆ¶
    muteBtn.addEventListener("click", function(e) {
        e.preventDefault();
        
        if (isMuted) {
            // å–æ¶ˆé™éŸ³
            audio.volume = previousVolume;
            volumeSlider.value = previousVolume * 100;
            muteBtn.innerHTML = self.getIconContent(self.unmuteIconTiddler, self.defaultUnmuteIcon, self.unmuteIconSize);
            isMuted = false;
        } else {
            // é™éŸ³
            previousVolume = audio.volume;
            audio.volume = 0;
            volumeSlider.value = 0;
            muteBtn.innerHTML = self.getIconContent(self.muteIconTiddler, self.defaultMuteIcon, self.muteIconSize);
            isMuted = true;
        }
    });
    
    // åˆ†ç¦»çš„éŸ³é‡é¢æ¿æ§åˆ¶
    volumeBtn.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // åˆ‡æ¢éŸ³é‡é¢æ¿æ˜¾ç¤º
        volumeVisible = !volumeVisible;
        volumePanel.classList.toggle("visible", volumeVisible);
    });
    
    volumeSlider.addEventListener("input", function() {
        var volume = this.value / 100;
        audio.volume = volume;
        
        if (volume === 0) {
            muteBtn.innerHTML = self.getIconContent(self.muteIconTiddler, self.defaultMuteIcon, self.muteIconSize);
            isMuted = true;
        } else {
            muteBtn.innerHTML = self.getIconContent(self.unmuteIconTiddler, self.defaultUnmuteIcon, self.unmuteIconSize);
            isMuted = false;
            if (volume > 0) {
                previousVolume = volume;
            }
        }
    });
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­éŸ³é‡é¢æ¿
    self.document.addEventListener("click", function(e) {
        if (!volumeBtn.contains(e.target) && !volumePanel.contains(e.target)) {
            volumeVisible = false;
            volumePanel.classList.remove("visible");
        }
    });
    
    // æ’­æ”¾ç»“æŸ
    audio.addEventListener("ended", function() {
        playButton.innerHTML = self.getIconContent(self.playIconTiddler, self.defaultPlayIcon, self.playIconSize);
        coverImg.classList.remove("spinning");
        isPlaying = false;
    });
    
    audio.addEventListener("error", function(e) {
        console.error("Audio error:", e);
        playButton.innerHTML = self.getIconContent(self.playIconTiddler, self.defaultPlayIcon, self.playIconSize);
        coverImg.classList.remove("spinning");
        isPlaying = false;
    });
};

GDStudioAudioWidget.prototype.refresh = function(changedTiddlers) {
    var changedAttributes = this.computeAttributes();
    if (Object.keys(changedAttributes).length > 0) {
        this.refreshSelf();
        return true;
    }
    return this.refreshChildren(changedTiddlers);
};

exports["gdstudio-audio"] = GDStudioAudioWidget;