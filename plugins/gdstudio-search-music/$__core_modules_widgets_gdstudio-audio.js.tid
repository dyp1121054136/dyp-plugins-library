created: 20250530105155960
modified: 20250530130618574
module-type: widget
tags: gdstudio éŸ³ä¹æ’­æ”¾å™¨
title: $:/core/modules/widgets/gdstudio-audio.js
type: application/javascript

/*\
title: $:/core/modules/widgets/gdstudio-audio.js
type: application/javascript
module-type: widget

GDStudio Audio Widget - è¿·ä½ éŸ³é¢‘æ’­æ”¾å™¨
\*/

"use strict";

var Widget = require("$:/core/modules/widgets/widget.js").widget;

var GDStudioAudioWidget = function(parseTreeNode,options) {
    this.initialise(parseTreeNode,options);
};

GDStudioAudioWidget.prototype = new Widget();

GDStudioAudioWidget.prototype.execute = function() {
    this.coverUrl = this.getAttribute("cover-url", "");
    this.musicUrl = this.getAttribute("music-url", "");
    this.songName = this.getAttribute("song-name", "æœªçŸ¥æ­Œæ›²");
    this.artist = this.getAttribute("artist", "æœªçŸ¥æ­Œæ‰‹");
    
    this.makeChildWidgets();
};

GDStudioAudioWidget.prototype.createDefaultCover = function() {
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
        '<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">' +
        '<rect width="100%" height="100%" fill="#f0f0f0"/>' +
        '</svg>'
    );
};

GDStudioAudioWidget.prototype.render = function(parent,nextSibling) {
    var self = this;
    this.parentDomNode = parent;
    this.computeAttributes();
    this.execute();
    
    var playerDiv = this.document.createElement("div");
    playerDiv.className = "gdstudio-mini-player";
    
    var coverContainer = this.document.createElement("div");
    coverContainer.className = "gdstudio-mini-cover";
    
    var coverImg = this.document.createElement("img");
    coverImg.src = this.coverUrl || this.createDefaultCover();
    coverImg.className = "gdstudio-mini-cover-img";
    
    var playButton = this.document.createElement("button");
    playButton.className = "gdstudio-mini-play-btn";
    playButton.innerHTML = "â–¶";
    
    coverContainer.appendChild(coverImg);
    coverContainer.appendChild(playButton);
    
    var infoSection = this.document.createElement("div");
    infoSection.className = "gdstudio-mini-info";
    
    var musicName = this.document.createElement("div");
    musicName.className = "gdstudio-music-name";
    musicName.textContent = this.songName + " - " + this.artist;
    
    var controls = this.document.createElement("div");
    controls.className = "gdstudio-mini-controls";
    
    var timeDisplay = this.document.createElement("span");
    timeDisplay.className = "gdstudio-time";
    timeDisplay.textContent = "0:00/0:00";
    
    var progressBar = this.document.createElement("div");
    progressBar.className = "gdstudio-progress";
    
    var progressFill = this.document.createElement("div");
    progressFill.className = "gdstudio-progress-fill";
    progressBar.appendChild(progressFill);
    
    // åˆå¹¶çš„éŸ³é‡æ§åˆ¶æŒ‰é’®
    var volumeBtn = this.document.createElement("button");
    volumeBtn.className = "gdstudio-volume-btn";
    volumeBtn.innerHTML = "ğŸ”Š";
    
    // éŸ³é‡é¢æ¿
    var volumePanel = this.document.createElement("div");
    volumePanel.className = "gdstudio-volume-panel";
    
    var volumeSlider = this.document.createElement("input");
    volumeSlider.type = "range";
    volumeSlider.min = "0";
    volumeSlider.max = "100";
    volumeSlider.value = "50";
    volumeSlider.className = "gdstudio-volume-slider";
    volumePanel.appendChild(volumeSlider);
    
    controls.appendChild(timeDisplay);
    controls.appendChild(progressBar);
    controls.appendChild(volumeBtn);
    controls.appendChild(volumePanel);
    
    infoSection.appendChild(musicName);
    infoSection.appendChild(controls);
    
    var audio = this.document.createElement("audio");
    if(this.musicUrl) {
        audio.src = this.musicUrl;
    }
    audio.preload = "metadata";
    audio.volume = 0.5; // è®¾ç½®åˆå§‹éŸ³é‡
    
    playerDiv.appendChild(coverContainer);
    playerDiv.appendChild(infoSection);
    playerDiv.appendChild(audio);
    
    // äº‹ä»¶å¤„ç†
    var isPlaying = false;
    var volumeVisible = false;
    var isMuted = false;
    var previousVolume = 0.5;
    
    // æ’­æ”¾æ§åˆ¶
// æš‚åœæ’­æ”¾çš„ SVG ä»£ç ï¼Œä»æ¡ç›®textè·å–
const pauseSvg = this.wiki.getTiddlerText("$:/core/images/gdstudio-pause-music");
    playButton.addEventListener("click", function() {
        if (!audio.src) return;
        if (isPlaying) {
            audio.pause();
            playButton.innerHTML = "â–¶";
            coverImg.classList.remove("spinning");
        } else {
            audio.play();
            playButton.innerHTML = pauseSvg;
            coverImg.classList.add("spinning");
        }
        isPlaying = !isPlaying;
    });
    
    // åˆå¹¶çš„éŸ³é‡æŒ‰é’®æ§åˆ¶
    volumeBtn.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (!volumeVisible) {
            // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šæ˜¾ç¤ºéŸ³é‡æ»‘å—
            volumeVisible = true;
            volumePanel.classList.add("visible");
        } else {
            // éŸ³é‡æ»‘å—å·²æ˜¾ç¤ºæ—¶ï¼šåˆ‡æ¢é™éŸ³çŠ¶æ€
            if (isMuted) {
                // å–æ¶ˆé™éŸ³
                audio.volume = previousVolume;
                volumeSlider.value = previousVolume * 100;
                volumeBtn.innerHTML = "ğŸ”Š";
                isMuted = false;
            } else {
                // é™éŸ³
                previousVolume = audio.volume;
                audio.volume = 0;
                volumeSlider.value = 0;
                volumeBtn.innerHTML = "ğŸ”‡";
                isMuted = true;
            }
        }
    });
    
    // éŸ³é‡æ»‘å—æ§åˆ¶
    volumeSlider.addEventListener("input", function() {
        var volume = this.value / 100;
        audio.volume = volume;
        
        if (volume === 0) {
            volumeBtn.innerHTML = "ğŸ”‡";
            isMuted = true;
        } else {
            volumeBtn.innerHTML = "ğŸ”Š";
            isMuted = false;
            if (volume > 0) {
                previousVolume = volume;
            }
        }
    });
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­éŸ³é‡é¢æ¿
    this.document.addEventListener("click", function(e) {
        if (!volumeBtn.contains(e.target) && !volumePanel.contains(e.target)) {
            volumeVisible = false;
            volumePanel.classList.remove("visible");
        }
    });
    
    // æ—¶é—´æ›´æ–°
    audio.addEventListener("timeupdate", function() {
        if (audio.duration) {
            var progress = (audio.currentTime / audio.duration) * 100;
            progressFill.style.width = progress + "%";
            
            var currentMin = Math.floor(audio.currentTime / 60);
            var currentSec = Math.floor(audio.currentTime % 60);
            var totalMin = Math.floor(audio.duration / 60);
            var totalSec = Math.floor(audio.duration % 60);
            
            timeDisplay.textContent = currentMin + ":" + (currentSec < 10 ? "0" : "") + currentSec + 
                                    "/" + totalMin + ":" + (totalSec < 10 ? "0" : "") + totalSec;
        }
    });
    
    audio.addEventListener("ended", function() {
        playButton.innerHTML = "â–¶";
        coverImg.classList.remove("spinning");
        isPlaying = false;
    });
    
    parent.insertBefore(playerDiv, nextSibling);
    this.domNodes.push(playerDiv);
};

GDStudioAudioWidget.prototype.refresh = function(changedTiddlers) {
    var changedAttributes = this.computeAttributes();
    if (Object.keys(changedAttributes).length > 0) {
        this.refreshSelf();
        return true;
    }
    return this.refreshChildren(changedTiddlers);
};

exports["gdstudio-audio"] = GDStudioAudioWidget;
